<!DOCTYPE html>
<html lang="en">
    <head>
		<meta charset="utf-8">
        <title>Пример опросника</title><meta name="viewport" content="width=device-width"/>
        <script src="https://unpkg.com/jquery"></script>
		<link href="https://unpkg.com/survey-jquery@1.8.18/modern.css" type="text/css" rel="stylesheet" />
        <link rel="stylesheet" href="https://unpkg.com/survey-core@1.8.18/survey.css"/></head>
		<link rel="stylesheet" href="https://unpkg.com/bootstrap@3.3.7/dist/css/bootstrap.min.css">
        <script src="https://unpkg.com/survey-jquery@1.8.18/survey.jquery.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
	</head>
    <body>
        <div id="surveyElement" style="display:inline-block;width:70%;"></div>
		<div id="results" style="width:70%;margin-left:auto;margin-right: auto;"></div>
		<div id="surveyContainer" style="width:70%;margin-left:auto;margin-right: auto;"></div>
		<div id="canvas-holder" style="width:40%;margin-left:auto;margin-right: auto;">
			<canvas id="myChart"></canvas>
		</div>
        <script type="text/javascript">
		let gl;
		(async function momSorryIAmGlobalAsyncCaller(){
		//Chart.defaults.global.legend.display = false;
		Survey.StylesManager.applyTheme();
		//Survey.StylesManager.applyTheme("bootstrap");
		//Survey.StylesManager.applyTheme("modern");
		//Survey.StylesManager.applyTheme('bootstrapmaterial');
		Survey.defaultBootstrapCss.navigationButton = "btn btn-green";
		/*<link rel="stylesheet" href="./index.css">*/
		let surveyJSON = {"pages":[{"name":"page1","elements":[{"type":"rating","name":"question1","title":"Оцените, насколько ваш начальник мудак по шкале от одного до десяти, где 1 - мой начальник не мудак, 10 - мой начальник полный мудак.","isRequired":true,"rateMax":10},{"type":"rating","name":"question2","title":"Оцените, насколько ваше мнение по вопросу, в котором вы компетентны, может повлиять на решения вашего начальника по соответствующему вопросу, где 1 - моё мнение никак не повлияет на решение, 10 - моё мнение будет учтено в полной мере.","isRequired":true,"rateMax":10}]}]}
		/* https://spreadsheets.google.com/feeds/cells/1hxlkL-pbx1JRfxPziwtPzMH5JM30mgsF6iW11-ySijs/1/public/values?alt=json-in-script */
		
		let response = await fetch('https://spreadsheets.google.com/feeds/cells/1hxlkL-pbx1JRfxPziwtPzMH5JM30mgsF6iW11-ySijs/1/public/values?alt=json-in-script');
		let spreadsheet = await response.text();
		spreadsheet = JSON.parse(spreadsheet.substring(28, spreadsheet.length-2))
		let qData = {}
		for(let i=0;i<spreadsheet.feed.entry.length;i+=1){
			if(! qData[parseInt(spreadsheet.feed.entry[i].gs$cell.row)]){
				qData[parseInt(spreadsheet.feed.entry[i].gs$cell.row)] = {}
			}
			qData[parseInt(spreadsheet.feed.entry[i].gs$cell.row)][parseInt(spreadsheet.feed.entry[i].gs$cell.col)] = spreadsheet.feed.entry[i].gs$cell.$t
		}
		
		//console.log(qData)
		let qCurNum = 1
		surveyJSON.pages[0].elements = new Array()
		
		newRate = (q, lhs, rhs)=>{
			surveyJSON.pages[0].elements.push({"type":"rating","name":"question" + qCurNum,"title":q,"isRequired":true,"rateMax":10, "minRateDescription": lhs, "maxRateDescription": rhs})
			qCurNum += 1
		}
		usedQ = new Array();
		for(let i=2; qData[i]; i+=1){
			if(qData[i][4]!='use') continue;
			newRate(qData[i][1], qData[i][2], qData[i][3])
			usedQ.push(i)
		}

		characteristics = new Array()
		
		for (let i=5;qData[1][i];i+=1){
			characteristics.push({name:qData[1][i], idx:i, val:0})
		}

		//alert(spreadsheet)
		function ShowRes(survey) {
			//alert("The results are:" + JSON.stringify(survey.data));
			characteristics.forEach((l, i, dat)=>{let sm = 0; usedQ.forEach(v=>{sm += survey.data['question'+(v-usedQ[0]+1)]*parseFloat(qData[v][l.idx])}); dat[i].val = sm})
			characteristics.forEach((l, i, dat)=>{let mx = 0; usedQ.forEach(v=>{mx += 10*parseFloat(qData[v][l.idx])}); dat[i].max = mx})
			console.log(qData)
			console.log(survey.data)
			console.log(characteristics)
			//console.log(usedQ, characteristics)
			//let autocr = survey.data.question1*0.99 + survey.data.question2*0.01;
			//let democr = survey.data.question1*0.01 + survey.data.question2*0.99;
			//let sm = autocr + democr;
			//autocr = autocr/sm;
			//democr = democr/sm;
			
			window.chartColors = {
				red: 'rgb(255, 99, 132)',
				orange: 'rgb(255, 159, 64)',
				yellow: 'rgb(255, 205, 86)',
				green: 'rgb(75, 192, 192)',
				blue: 'rgb(54, 162, 235)',
				purple: 'rgb(153, 102, 255)',
				grey: 'rgb(201, 203, 207)'
			};
			var config = {
				type: 'radar',
				data: {
					datasets: [{
						borderColor: window.chartColors.yellow,
						fill: false,
						data: characteristics.filter(v=>v.max>0).map(v=>(v.val/v.max) * 100),
						backgroundColor: [
							window.chartColors.red,
							window.chartColors.blue,
							window.chartColors.yellow,
							window.chartColors.green,
							window.chartColors.orange,
							window.chartColors.purple,
							window.chartColors.grey,
						],
						label: 'Степень выраженности характеристики'
					}],
					labels: characteristics.filter(v=>v.max>0).map(v=>v.name)
				},
				options: {
					maintainAspectRatio: true,
					spanGaps: false,
					responsive: true,
					legend: {
						display:false,
						position: 'top',
					},
					title: {
						display: true,
						text: 'Выраженность характеристик'
					},
					animation: {
						animateScale: true,
						animateRotate: true
					},
					scale: {
						ticks: {
							max: 100,
							min: 0,
							//stepSize: 0.5,
							beginAtZero:true
						}
					}
				}
			};
			var ctx = document.getElementById('myChart').getContext('2d');
			if(window.myDoughnut){
				window.myDoughnut.destroy();
			}
			window.myDoughnut = new Chart(ctx, config);
		
			survey = new Survey.Model(surveyJSON);
			$("#surveyContainer").Survey({
				model: survey,
				onComplete: ShowRes
			});
		}

		let survey = new Survey.Model(surveyJSON);
		$("#surveyContainer").Survey({
			model: survey,
			onComplete: ShowRes
		});

		})()
		</script>
    </body>
</html>